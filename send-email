#!/usr/bin/env bash

# Check for required environment variables
if [ -z "$DEFAULT_ADMIN_EMAIL" ] || [ -z "$SCRIPT_SMTP_SERVER" ] || [ -z "$SCRIPT_SMTP_PORT" ] || [ -z "$SCRIPT_SMTP_LOGIN" ] || [ -z "$SCRIPT_SMTP_KEY" ]; then
  echo "Error: Please set the required environment variables: DEFAULT_ADMIN_EMAIL, SCRIPT_SMTP_SERVER, SCRIPT_SMTP_PORT, SCRIPT_SMTP_LOGIN, SCRIPT_SMTP_KEY"
  exit 1
fi

# Default recipient
DEFAULT_RECIPIENT="$DEFAULT_ADMIN_EMAIL"

# Initialize variables
recipient=""
subject=""
attachment=""
body=""

# Parse command-line options
while getopts "r:s:a:b:" opt; do
  case $opt in
    r) recipient="$OPTARG" ;;
    s) subject="$OPTARG" ;;
    a) attachment="$OPTARG" ;;
    b) body="$OPTARG" ;;
    \?) echo "Invalid option: -$OPTARG" >&2; exit 1 ;;
  esac
done

# Set recipient to default if not provided
if [ -z "$recipient" ]; then
  recipient="$DEFAULT_RECIPIENT"
fi

# Check for required options
if [ -z "$subject" ] || [ -z "$body" ]; then
  echo "Usage: $0 -s <subject> -b <body> [-r <recipient>] [-a <attachment>]"
  exit 1
fi

# Construct the smtp_url
smtp_url="smtp://${SCRIPT_SMTP_LOGIN//\@/%40}:${SCRIPT_SMTP_KEY}@${SCRIPT_SMTP_SERVER}:${SCRIPT_SMTP_PORT}"

# Construct and execute the mutt command
if [ -n "$attachment" ]; then
  echo "$body" | mutt -s "$subject" -e "set from='$DEFAULT_ADMIN_EMAIL'" -e "set realname='Carl Kamper'" -e "set smtp_url='$smtp_url'" -e "set ssl_starttls=yes" -a "$attachment" -- "$recipient"
else
  echo "$body" | mutt -s "$subject" -e "set from='$DEFAULT_ADMIN_EMAIL'" -e "set realname='Carl Kamper'" -e "set smtp_url='$smtp_url'" -e "set ssl_starttls=yes" -- "$recipient"
fi

echo "Email sent to $recipient"
